{% extends 'profiles/base.html' %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="text-success mb-1">üì∞ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</h2>
                <p class="text-muted mb-0">–í—ã–±–µ—Ä–∏—Ç–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏ –∏ —É–ø—Ä–∞–≤–ª—è–π—Ç–µ —Ç–µ–∫—É—â–∏–º–∏ –ø–æ–¥–ø–∏—Å–∫–∞–º–∏</p>
            </div>
            
            {% if user.is_staff %}
            {% endif %}
        </div>
    </div>
</div>

<div class="row">
    <div class="col-12">
        <!-- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–æ–∫ -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card bg-success text-white">
                    <div class="card-body text-center">
                        <h4>{{ subscriptions_active.count }}</h4>
                        <small>–ê–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-warning text-white">
                    <div class="card-body text-center">
                        <h4>{{ subscriptions_pending.count }}</h4>
                        <small>–û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card bg-secondary text-white">
                    <div class="card-body text-center">
                        <h4>{{ websites_available }}</h4>
                        <small>–î–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- –§–æ—Ä–º–∞ –≤—ã–±–æ—Ä–∞ –ø–æ–¥–ø–∏—Å–æ–∫ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">üåê –î–æ—Å—Ç—É–ø–Ω—ã–µ —Å–µ—Ä–≤–∏—Å—ã –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏</h5>
            </div>
            <div class="card-body">
                <form method="post">
                    {% csrf_token %}
                    
                    {% for category, websites in websites_by_category.items %}
                        <div class="category-section mb-4">
                            <h6 class="category-title mb-3">
                                <span class="badge bg-success me-2">{{ websites|length }}</span>
                                {{ category }}
                            </h6>
                            
                            <div class="row">
                                {% for website in websites %}
                                    <div class="col-md-6 mb-3">
                                        <div class="website-card card h-100 {% if website.id in current_subscriptions %}border-success{% endif %}">
                                            <div class="card-body">
                                                <div class="form-check mb-2">
                                                    <input class="form-check-input" type="checkbox" 
                                                           name="websites" value="{{ website.id }}" 
                                                           id="website{{ website.id }}"
                                                           {% if website.id in current_subscriptions %}checked{% endif %}>
                                                    <label class="form-check-label fw-bold" for="website{{ website.id }}">
                                                        {{ website.name }}
                                                    </label>
                                                </div>
                                                
                                                <p class="text-muted small mb-2">{{ website.description }}</p>
                                                
                                                <div class="website-meta">
                                                    <small class="text-muted">
                                                        <strong>URL:</strong> 
                                                        <a href="{{ website.url }}" target="_blank" class="text-decoration-none">
                                                            {{ website.url }}
                                                        </a>
                                                    </small>
                                                    <br>
                                                    <small class="text-muted">
                                                        <strong>–î–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å:</strong> 
                                                        {% if website.duration_days == 0 %}
                                                            <span class="text-success">‚ôæÔ∏è –ë–µ—Å—Å—Ä–æ—á–Ω–∞—è</span>
                                                        {% else %}
                                                            <span class="text-info">{{ website.duration_days }} –¥–Ω–µ–π</span>
                                                        {% endif %}
                                                    </small>
                                                    <br>
                                                    <small class="text-muted">
                                                        <strong>–ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ:</strong> 
                                                        {% if website.requires_approval %}
                                                            <span class="text-warning">‚è≥ –¢—Ä–µ–±—É–µ—Ç—Å—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –∞–¥–º–∏–Ω–∞</span>
                                                        {% else %}
                                                            <span class="text-success">‚ö° –ú–≥–Ω–æ–≤–µ–Ω–Ω–∞—è –∞–∫—Ç–∏–≤–∞—Ü–∏—è</span>
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% empty %}
                        <div class="text-center py-4">
                            <p class="text-muted">–ù–µ—Ç –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —Å–µ—Ä–≤–∏—Å–æ–≤ –¥–ª—è –ø–æ–¥–ø–∏—Å–∫–∏.</p>
                        </div>
                    {% endfor %}
                    
                    {% if websites_by_category %}
                        <div class="mt-4 p-3 bg-light rounded">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="selectAll">
                                <label class="form-check-label fw-bold" for="selectAll">
                                    –í—ã–±—Ä–∞—Ç—å –≤—Å–µ —Å–µ—Ä–≤–∏—Å—ã
                                </label>
                            </div>
                            
                            <div class="mt-3">
                                <button type="submit" class="btn btn-success btn-lg">
                                    üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–æ–∫
                                </button>
                                <a href="{% url 'profile' %}" class="btn btn-secondary btn-lg">‚ùå –û—Ç–º–µ–Ω–∞</a>
                            </div>
                        </div>
                    {% endif %}
                </form>
            </div>
        </div>
        
        <!-- –¢–µ–∫—É—â–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
{% if subscriptions_active or subscriptions_pending %}
<div class="card mt-4">
    <div class="card-header">
        <h5 class="mb-0">üìã –ú–æ–∏ –ø–æ–¥–ø–∏—Å–∫–∏</h5>
        <small class="text-muted">–ò—Å—Ç–µ–∫—à–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Å–∫—Ä—ã–≤–∞—é—Ç—Å—è –∏–∑ —ç—Ç–æ–≥–æ —Å–ø–∏—Å–∫–∞</small>
    </div>
    <div class="card-body">
        <!-- –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ -->
        {% if subscriptions_active %}
        <h6 class="text-success mb-3">
            ‚úÖ –ê–∫—Ç–∏–≤–Ω—ã–µ –ø–æ–¥–ø–∏—Å–∫–∏ 
            <span class="badge bg-success">{{ subscriptions_active.count }}</span>
        </h6>
        <div class="row">
            {% for subscription in subscriptions_active %}
                <div class="col-md-6 mb-3">
                    <div class="card border-success">
                        <div class="card-body">
                            <h6 class="card-title">üåê {{ subscription.website.name }}</h6>
                            <p class="card-text small text-muted mb-2">
                                {{ subscription.website.description }}
                            </p>
                            <div class="subscription-info">
                                <small class="text-muted">
                                    <strong>–ü–æ–¥–ø–∏—Å–∞–Ω:</strong> {{ subscription.subscribed_at|date:"d.m.Y" }}
                                </small>
                                <br>
                                {% if subscription.expires_at %}
                                    <small class="text-muted">
                                        <strong>–ò—Å—Ç–µ–∫–∞–µ—Ç:</strong> 
                                        <span class="{% if subscription.days_remaining < 7 %}text-danger{% elif subscription.days_remaining < 30 %}text-warning{% else %}text-success{% endif %}">
                                            {{ subscription.expires_at|date:"d.m.Y" }} 
                                            (–æ—Å—Ç–∞–ª–æ—Å—å {{ subscription.days_remaining }} –¥–Ω.)
                                        </span>
                                    </small>
                                {% else %}
                                    <small class="text-success">
                                        <strong>–°—Ç–∞—Ç—É—Å:</strong> ‚ôæÔ∏è –ë–µ—Å—Å—Ä–æ—á–Ω–∞—è
                                    </small>
                                {% endif %}
                                <br>
                                <small class="text-muted">
                                    <strong>–ê–≤—Ç–æ–ø—Ä–æ–¥–ª–µ–Ω–∏–µ:</strong> 
                                    {% if subscription.website.duration_days > 0 %}
                                        <span class="text-info">üîÑ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å—Ç–µ—á–µ—Ç</span>
                                    {% else %}
                                        <span class="text-success">‚úÖ –ë–µ—Å—Å—Ä–æ—á–Ω–∞—è</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-3">
            <p class="text-muted">–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫</p>
        </div>
        {% endif %}
        
        <!-- –û–∂–∏–¥–∞—é—â–∏–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
        {% if subscriptions_pending %}
        <h6 class="text-warning mb-3 mt-4">
            ‚è≥ –û–∂–∏–¥–∞—é—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è 
            <span class="badge bg-warning">{{ subscriptions_pending.count }}</span>
        </h6>
        <div class="row">
            {% for subscription in subscriptions_pending %}
                <div class="col-md-6 mb-3">
                    <div class="card border-warning">
                        <div class="card-body">
                            <h6 class="card-title">üåê {{ subscription.website.name }}</h6>
                            <p class="card-text small text-muted mb-2">
                                {{ subscription.website.description }}
                            </p>
                            <div class="subscription-info">
                                <small class="text-warning">
                                    <strong>–°—Ç–∞—Ç—É—Å:</strong> –û–∂–∏–¥–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
                                </small>
                                <br>
                                <small class="text-muted">
                                    <strong>–ó–∞–ø—Ä–æ—à–µ–Ω–æ:</strong> {{ subscription.subscribed_at|date:"d.m.Y H:i" }}
                                </small>
                                <br>
                                {% if subscription.website.duration_days > 0 %}
                                    <small class="text-info">
                                        <strong>–ë—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ:</strong> {{ subscription.website.duration_days }} –¥–Ω–µ–π –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                                    </small>
                                {% else %}
                                    <small class="text-success">
                                        <strong>–ë—É–¥–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ:</strong> ‚ôæÔ∏è –ë–µ—Å—Å—Ä–æ—á–Ω–æ –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è
                                    </small>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% endfor %}
        </div>
        {% endif %}
    </div>
</div>
{% endif %}
    </div>
</div>

<style>
    .category-title {
        color: var(--primary-color);
        font-weight: 600;
        padding-bottom: 8px;
        border-bottom: 2px solid var(--primary-light);
    }
    
    .website-card {
        transition: all 0.3s ease;
        border: 1px solid #dee2e6;
    }
    
    .website-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        border-color: var(--primary-color);
    }
    
    .website-card.border-success {
        background: linear-gradient(135deg, #f8fff8, #f0fff0);
    }
    
    .subscription-info {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
        margin-top: 10px;
    }
</style>

<script>
    // –°–∫—Ä–∏–ø—Ç –¥–ª—è –≤—ã–±–æ—Ä–∞ –≤—Å–µ—Ö —á–µ–∫–±–æ–∫—Å–æ–≤
    document.getElementById('selectAll').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('input[name="websites"]');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
</script>
{% endblock %}